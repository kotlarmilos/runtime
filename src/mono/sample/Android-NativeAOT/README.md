# NativeAOT Android sample app

## Description

This project aims to explore the possibilities and limitations of running Android apps with Native AOT. This sample application serves as a functional test that should verify NativeAOT support for Android emulators and devices. The sample shares the source code with the Mono sample at `../Android/Program.cs` and in general should have the same behavior as Mono AOT.

## How to build and test

When building for the first time (on a clean checkout) run the commands below.

Setup the local environment:
```bash
git clone https://github.com/kotlarmilos/runtime.git
```
```bash
git checkout feature/nativeaot-android-poc
```

Export the SDK and NDK:
```bash
export ANDROID_SDK_ROOT=~/android-sdk                                                                             
export ANDROID_NDK_ROOT=~/android-ndk-r23c
```
Build the ilc for the host:
```bash
./build.sh clr+clr.aot
```
Build the native and managed libs for the linux-bionic target:
```bash
TARGET_BUILD_ARCH=arm64 ./build.sh -s clr.nativeaotruntime+clr.nativeaotlibs+libs -os linux-bionic
```

Generate the app bundle:
``` bash
make run
```

## Tasks

The goal of this experiment is to allow running Maui apps on Android devices with Native AOT. Outcome of this experiment should be a document with SOD and startup measurements comparing Mono and Native AOT runtimes, and list of tasks that needs to be done in order to support it as an opt-in feature within the .NET.

### Make the sample app works with Native AOT

The current version contains a number of workarounds or hardcoded values which should be replaced with correct logic.

**Relocation issue:** When generating a shared native library, GC symbols should be marked as local due to relocation issues. Generate an `.exports` file that exposes only entry points and marks all other symbols as local.
```
V1.0 {
    global: _init; _fini; __managed__Main; Java_net_dot_MonoRunner_setEnv; Java_net_dot_MonoRunner_initRuntime; Java_net_dot_MonoRunner_intFromJNI;
    local: *;
};
```
**JNI dependency issue:** When running application on Android emulator, the `DotnetProxyTrustManager` can't be found. Investigate why it is missing from the bundle and propose a solution.

**Dynamic libraries issue:** The application requires dynamic native libs which are currently not generated by the ApkBuilder.
```c#
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libSystem.Native.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libSystem.Security.Cryptography.Native.Android.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libmonosgen-2.0.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libSystem.IO.Compression.Native.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libmono-component-marshal-ilgen.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
Utils.RunProcess(logger, aapt, $"add {apkFile} lib/arm64-v8a/libSystem.Globalization.Native.so", workingDir: "PATH_TO_DYNAMIC_LIBS");
```

**Code cleanup:** Simpify the `monodroid.c` and `MonoRunner.java` so they don't include Mono-specific dependencies.


### Enable AndroidAppBuilder to bundle applications compiled with Native AOT

The AndroidAppBuilder build task currently only supports Mono as the default AOT compiler and runtime when creating application bundles. Extend AndroidAppBuilder and ApkBuilder to support Native AOT, as an alternative AOT compiler and runtime, when creating Android application. This may require updating the cmake template and MonoRunner.java files.

### Enable building Native AOT for android platforms

Runtime currently does not support building Native AOT subset (aotsdk) for Android platforms. Additionally, building an appropriate runtime NuGet package for these platforms is also unavailable.
Runtime and functional tests require cross building as a single command, targeting the ilc for the host and the SDK for the target.

### Use logcat for Console.WriteLine

When the runtime is built for linux-bionic, the Console.WriteLine doesn't work since logcat support is not included. Once the build for android platforms is implemented, ensure that appropriate logcat native functions are used.

```h
void mono_log_open_logcat (const char *path, void *userData);
void mono_log_write_logcat (const char *log_domain, GLogLevelFlags level, mono_bool hdr, const char *message);
void mono_log_close_logcat (void);
```

### Performance measurements

Collect data on startup time, SOD, and build time for both HelloWorld and Xamarin SingleView static regstrar apps. Validate their functionality to ensure the experiment results are reliable.

### .NET 9 tasks

- Check with the Android team on use of reflection and possible limitations
- Enable dotnet SDK to support targeting android with native AOT
- Enable runtime and library tests running with Native AOT
- Add Native AOT Android perf scenarios
- Document support